<?php

/**
 * Implementation of hook_gm3_alter().
 */
function npt_maps_gm3_map_alter(&$map){
  // Add the country mask to a google map on taxonomy term pages only.
  if($term = menu_get_object('taxonomy_term', 2)){

    // Use external KML files
    $map['libraries']['npt_country_mask'] = array(
      'module' => 'npt_maps',
    );
    
    // Use gm3_region data
    /*
    $map['libraries']['region'] = array(
      'module' => 'gm3_region',
        'regions' => array(
        '1:10:BEN'
       )
     );
    $map['libraries']['polygon'] = array();
    */
  }
}

/**
 * Implementation of hook_library().
 */
function npt_maps_library(){
  // Prepare coordinate and polygon information.
  // The country is first decided by the Participant setting
  $gbif_participant_settings = variable_get('gbif_participant_settings');
  $iso3 = _npt_startup_get_iso3_by_iso2($gbif_participant_settings['node_country']);
  
  $polygon_results = db_select('gm3_region_data', 'g')
               ->fields('g', array('polygons'))
               ->condition('level_3_code', $iso3)
               ->execute()
               ->fetchField();
               
  // Calculate the centre point of the polygon
  gm3_load_geophp();
  
  $polygon = geoPHP::load($polygon_results);
  $centroid = $polygon->getCentroid();
  $centX = $centroid->getX();
  $centY = $centroid->getY();
  
  // The four points of the masking polygon.
  $maxX = if ($centX + 60)

  return array(
    'npt_country_mask' => array(
      'title' => t('Country mask'),
      'version' => '0.1',
      'js' => array(
        array(
          'data' => drupal_get_path('module', 'npt_maps') . "/js/npt_maps.js"
        ),
      ),
      'css' => array(
        array(
          'data' => drupal_get_path('module', 'npt_maps') . '/css/npt_maps.css'
        )
      ),
      'dependencies' => array(
        array(
          'gm3',
        )
      )
    )
  );
}
