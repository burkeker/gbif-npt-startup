<?php
/**
 * @file
*
* Test case for Darwincore with selenium
*/
if(!class_exists('DrupalSeleniumWebTestCase')){
  drupal_set_message(t('Selenium tests are not displayed because the selenium module is not enabled.'), 'warning', FALSE);
  return;
}

class ScratchpadsForumSeleniumTestCase extends ScratchpadsTweaksSeleniumTestCase{

  protected $admin_user2;

  public static function getInfo(){
    return array(
      'name' => 'Scratchpads Forum',
      'description' => 'Tests for scratchpads forum',
      'group' => 'Scratchpads Selenium',
      'browsers' => array(
        'firefox'
      )
    );
  }

  public function setUp(){
    $modules[] = 'scratchpads_forum';
    parent::setUp($modules);
    $this->admin_user2 = $this->drupalCreateUserWithName(array(
      'access content',
      'access administration pages',
      'administer site configuration',
      'administer users',
      'administer permissions',
      'administer content types',
      'administer nodes',
      'bypass node access',
      'access content overview',
      'view the administration theme',
      'access all views',
      'administer comments',
      'administer front page',
      'access toolbar',
      'administer forums'
    ), 'admin-user2');
    legal_save_accept(1, 1, 'en', $this->admin_user2->uid);
  }

  /**
   * A wrapper for the following tests
   * 
   * - Create forums
   * - Create forum topics
   * - Test forum tree functionality
   */
  function testWrapper(){
    $this->drupalLogin($this->admin_user2);
    $forum_topic_title = $this->verifyCreateForumTopic('General discussion');
    $forum_topic_title2 = $this->verifyCreateForumTopic('General discussion');
    $forum1 = $this->addForum('<root>');
    $forum_topic_title3 = $this->verifyCreateForumTopic($forum1);
    $forum_topic_title4 = $this->verifyCreateForumTopic($forum1);
    // We have 2 forums, and 2 forum topics for each forum
    $forum_array = array(
      'General discussion' => array(
        $forum_topic_title,
        $forum_topic_title2
      ),
      $forum1 => array(
        $forum_topic_title3,
        $forum_topic_title4
      )
    );
    $this->verifyForumTree($forum_array);
  }

  /**
   * Create forum topic
   */
  function verifyCreateForumTopic($container){
    $this->drupalGet('node/add/forum');
    $title = $this->randomName();
    $body = $this->randomName();
    $element = $this->driver->getElement("name=title");
    $element->clear();
    $element->sendKeys($title);
    $element = $this->driver->getElement("name=body[und][0][value]");
    $element->clear();
    $element->sendKeys($body);
    $element = $this->driver->getElement("name=taxonomy_forums[und]");
    $element->selectLabel($container);
    // Submit the form
    $this->driver->getElement("id=edit-submit")->click();
    $this->assertText($title . ' has been created', 'Forum topic successfully created');
    return $title;
  }

  /**
   * Create forum 
   */
  function addForum($parent){
    $this->drupalGet('admin/structure/forum/add/forum');
    $title = $this->randomName();
    $element = $this->driver->getElement("name=name");
    $element->clear();
    $element->sendKeys($title);
    $element = $this->driver->getElement("name=parent[0]");
    $element->selectLabel($parent);
    $this->driver->getElement("id=edit-submit")->click();
    $this->assertText('Created new forum ' . $title, 'Forum topic successfully created');
    return $title;
  }

  /**
   * Test the forum tree functionality
   */
  function verifyForumTree($forum_array){
    $this->drupalGet('forum');
    // Clicking on the forum name should reveal the forum topics
    foreach($forum_array as $forum => $topic_array){
      $this->clickLink($forum);
      foreach($topic_array as $topic){
        $this->asserttext($topic, 'Forum topic displayed when forum clicked');
      }
    }
  }
}