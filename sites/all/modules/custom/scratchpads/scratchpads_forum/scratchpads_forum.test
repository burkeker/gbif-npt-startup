<?php

/**
 * @file
*
* Scratchpads Forum tests.
* Tests components on a "FULL" Scratchpad.
*/
class ScratchpadsForumTestCase extends DrupalWebTestCase{

  protected $test_user;
  // necessary if we want to use tweaks
  protected $profile = 'testing';

  public static function getInfo(){
    return array(
      'name' => 'Scratchpads Forum',
      'description' => 'Testing for scratchpads forum module',
      'group' => 'Scratchpads'
    );
  }

  /**
   * Enable modules and create users with specific permissions.
   */
  public function setUp(){
    // Set the max execution time to 20 minutes.  This may seem like a long time,
    // but the scratchpads_tweaks module does take a long time to install.
    ini_set('max_execution_time', '1200');
    parent::setUp('forum', 'scratchpads_forum', 'scratchpads_tweaks');
    // Run the scratchpads_tweaks_install() function.
    scratchpads_tweaks_install();
    // Create users.
    $this->test_user = $this->drupalCreateUser(array(
      'access content'
    ));
    // We set the legal_accepted on the user so that login passes.
    user_save($this->test_user, array(
      'legal_accept' => TRUE
    ));
  }

  /**
   * Tests block_info() for the scratchpads forum module.
   */
  public function testScratchpadsForumBlockInfo(){
    $info = module_invoke('scratchpads_forum', 'block_info');
    $this->assertEqual(1, count($info), t('Module defines a block'));
    $this->assertTrue(isset($info['scratchpadsforum_tree']), t('Scratchpads forum tree exists.'));
  }

  /**
   * Tests block_view() for the scratchpads forum module.
   */
  public function testScratchpadsForumBlockView(){
    $data = module_invoke('scratchpads_forum', 'block_view', 'scratchpadsforum_tree');
    $this->assertTrue(is_array($data), t('Block returns renderable array.'));
  }

  /**
   * Tests that the scratchpads forum tree block appears on the correct pages.
   */
  public function testScratchpadsForumTree(){
    // Test that the block appears on the forum page
    $this->drupalLogin($this->test_user);
    $this->drupalGet('forum');
    $this->assertRaw('block-scratchpads-forum-scratchpadsforum-tree', "Forum tree block present on forum overview page (/forum)");
    // Test that the block does not appear on the home page
    $this->drupalGet('');
    $this->assertnoRaw('block-scratchpads-forum-scratchpadsforum-tree', 'Forum tree block not present on home page');
    // test that the block appears on a forum topic page
    $forum_node = $this->drupalCreateNode(array(
      'type' => 'forum'
    ));
    $path = 'node/' . $forum_node->nid;
    $this->drupalGet($path);
    $this->assertRaw('block-scratchpads-forum-scratchpadsforum-tree', 'Forum tree block present on a forum topic page (/node/*)');
    // Test that the block does not appear on other node pages
    $forum_node = $this->drupalCreateNode(array(
      'type' => 'page'
    ));
    $path = 'node/' . $forum_node->nid;
    $this->drupalGet($path);
    $this->assertnoRaw('block-scratchpads-forum-scratchpadsforum-tree', 'Forum tree block not present on basic page (/node/*)');
  }
}