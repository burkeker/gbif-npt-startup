<?php

/**
 * Implements hook_menu()
 */
function scratchpads_qa_menu(){
  return array(
    'results/front' => array(
      'title' => 'Scratchpads Tests',
      'page callback' => 'scratchpads_qa_front',
      'access callback' => TRUE
    ),
    'results/latest' => array(
      'title' => 'Latest Scratchpads Test Result',
      'page callback' => 'scratchpads_qa_latest',
      'access callback' => TRUE
    ),
    'results/%' => array(
      'title' => 'Scratchpads Test Result',
      'page callback' => 'scratchpads_qa_result',
      'page arguments' => array(
        1
      ),
      'access callback' => TRUE
    )
  );
}

/**
 * Implements hook_block_info()
 */
function scratchpads_qa_block_info(){
  return array(
    'overview' => array(
      'info' => t('Scratchpads Tests Overview'),
      'cache' => DRUPAL_NO_CACHE
    )
  );
}

/**
 * Callback to display a specific result set.
 */
function scratchpads_qa_result($test_id){
  $form_state = array();
  module_load_include('pages.inc', 'simpletest');
  $form = simpletest_result_form(array(), $form_state, $test_id);
  unset($form['action']);
  unset($form['#action']);
  foreach(array_keys($form['result']['results']) as $key){
    if(isset($form['result']['results'][$key]['table']['#header'][5])){
      unset($form['result']['results'][$key]['table']['#header'][5]);
      unset($form['result']['results'][$key]['table']['#header'][2]);
      foreach(array_keys($form['result']['results'][$key]['table']['#rows']) as $row_key){
        unset($form['result']['results'][$key]['table']['#rows'][$row_key]['data'][5]);
        unset($form['result']['results'][$key]['table']['#rows'][$row_key]['data'][2]);
      }
      $form['result']['results'][$key]['table']['#header'][0] = array(
        'data' => 'Message',
        'class' => array(
          'wider'
        )
      );
    }
  }
  return $form;
}

/**
 * Callback to display the latest test results
 */
function scratchpads_qa_latest(){
  // Get the highest test_id
  $query = db_select('simpletest', 's');
  $query->addExpression('MAX(s.test_id)', 'max_test_id');
  $test_id = $query->execute()->fetchField();
  if(!$test_id){return array(
      '#markup' => t('No tests to display')
    );}
  return scratchpads_qa_result($test_id);
}

/**
 * Callback to display a page suitable for the front of the QA site.
 */
function scratchpads_qa_front(){
  return array(
    'overview' => scratchpads_qa_block_view('overview')
  );
}

/**
 * Implements hook_block_view()
 */
function scratchpads_qa_block_view($delta){
  switch($delta){
    case 'overview':
      // FIXME
      // As I have no idea how to do "test_class = s.test_class" in a subquery,
      // without the s.test_class being escaped as if it were a string rather
      // than a DB column name, I'm having to do this using db_query.  Ugly, but
      // necessary.
      $status = db_query('SELECT status, COUNT(*) AS count_status FROM {simpletest} s WHERE test_id = (SELECT MAX(test_id) FROM {simpletest} WHERE test_class = s.test_class) GROUP BY status')->fetchAllKeyed();
      return array(
        'subject' => t('Latest test results'),
        'content' => array(
          '#attached' => array(
            'css' => array(
              drupal_get_path('module', 'scratchpads_qa') . '/css/scratchpads_qa.css',
              drupal_get_path('module', 'simpletest') . '/simpletest.css'
            )
          ),
          'table' => array(
            '#attributes' => array(
              'class' => array(
                'qa-overview'
              )
            ),
            '#theme' => 'table',
            '#header' => array(
              'Status',
              'Count'
            ),
            '#rows' => array(
              array(
                'data' => array(
                  'Passes',
                  $status['pass']
                ),
                'class' => $status['pass'] ? array(
                  'simpletest-pass'
                ) : array(
                  'simpletest-fail'
                )
              ),
              array(
                'data' => array(
                  'Fails',
                  $status['fail']
                ),
                'class' => $status['fail'] ? array(
                  'simpletest-fail'
                ) : array(
                  'simpletest-pass'
                )
              ),
              array(
                data => array(
                  'Exceptions',
                  $status['exception']
                ),
                'class' => $status['exception'] ? array(
                  'simpletest-exception'
                ) : array(
                  'simpletest-pass'
                )
              )
            )
          ),
          'link' => array(
            '#theme' => 'link',
            '#path' => 'results/latest',
            '#text' => t('More detail'),
            '#options' => array(
              'attributes' => array(
                'class' => array(
                  'qa-overview'
                )
              )
            )
          )
        )
      );
  }
}
