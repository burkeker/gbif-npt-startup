<?php

/**
 * Implements hook_menu()
 */
function scratchpads_qa_menu(){
  return array(
    'results/front' => array(
      'title' => 'Scratchpads Tests',
      'page callback' => 'scratchpads_qa_front',
      'acccess arguments' => array(
        'access content'
      )
    ),
    'results/latest' => array(),
    'results/%' => array()
  );
}

/**
 * Implements hook_block_info()
 */
function scratchpads_qa_block_info(){
  return array(
    'overview' => array(
      'info' => t('Scratchpads Tests Overview'),
      'cache' => DRUPAL_CACHE_GLOBAL
    )
  );
}

/**
 * Implements hook_block_view()
 */
function scratchpads_qa_block_view($delta){
  switch($delta){
    case 'overview':
      // Get the highest test_id
      $query = db_select('simpletest', 's');
      $query->addExpression('MAX(s.test_id)', 'max_test_id');
      $test_id = $query->execute()->fetchField();
      if(!$test_id){return array();}
      $query = db_select('simpletest', 's');
      $query->addExpression('COUNT(*)', 'count_status');
      $status = $query->fields('s', array(
        'status'
      ))->groupBy('status')->execute()->fetchAllKeyed();
      return array(
        'subject' => NULL,
        'content' => array(
          '#theme' => 'table',
          '#header' => array(
            'Status',
            'Count'
          ),
          '#rows' => array(
            array(
              'Passes',
              $status['pass']
            ),
            array(
              'Fails',
              $status['fail']
            ),
            array(
              'Exceptions',
              $status['exception']
            )
          )
        )
      );
  }
}