<?php

/**
 * Implements hook_form_FORM_ID_alter
 * 
 * We add a drop down list of fields in the exposed form
 */
function scratchpads_views_filter_form_views_exposed_form_alter(&$form, &$form_state, $form_id){
  if(strpos($form_state['view']->name, 'admin_vbo_node') !== false){
    $optionsarray = array();
    $optionsarray[0] = '- Select a Field -';
    $has_taxa = false;
    foreach($form['#info'] as $key => $element){
      if(substr($element['label'], 0, 6) == 'Taxa |'){
        $has_taxa = true;
      }
    }
    foreach($form['#info'] as $key => $element){
      $key2 = 'views-widget-' . $key;
      // Add Option Groups for Location and Taxa
      if(substr($element['label'], 0, 10) == 'Location |'){
        $optionsarray['Location Fields'][$key2] = substr($element['label'], 11);
      }elseif(substr($element['label'], 0, 6) == 'Taxa |'){
        $optionsarray['Taxa'][$key2] = substr($element['label'], 7);
      }elseif($has_taxa){
        $optionsarray['Other Fields'][$key2] = $element['label'];
      }else{
        $optionsarray['Fields'][$key2] = $element['label'];
      }
    }
    $newform = array();
    $newform['selected'] = array(
      '#type' => 'select',
      '#options' => $optionsarray,
      '#weight' => -15
    );
    foreach($form as $key => $element){
      $newform[$key] = $element;
    }
    $form = $newform;
    $newforminfo = array();
    $newforminfo['selected'] = array(
      'operator' => '',
      'value' => 'selected',
      'label' => 'Filter By Fields',
      'description' => ''
    );
    foreach($form['#info'] as $key => $element){
      $newforminfo[$key] = $element;
    }
    $form['#info'] = $newforminfo;
    $form['#attached']['js'][] = drupal_get_path('module', 'scratchpads_views_filter') . '/js/scratchpads_views_filter.js';
    $form['#attached']['css'][] = drupal_get_path('module', 'scratchpads_views_filter') . '/css/scratchpads_views_filter.css';
  }
}
