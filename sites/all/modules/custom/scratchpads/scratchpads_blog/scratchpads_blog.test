<?php

/**
 * @file
 * 
 * Scratchpads Blog tests.  
 * Tests components on a "FULL" Scratchpad.
 */
class ScratchpadsBlogTestCase extends ScratchpadsTweaksTestCase{

  protected $test_user;

  public static function getInfo(){
    return array(
      'name' => 'Scratchpads Blog',
      'description' => 'Testing for scratchpads blog module',
      'group' => 'Scratchpads'
    );
  }

  /**
   * Enable modules and create users with specific permissions.
   */
  public function setUp(){
    $modules[] = 'blog';
    $modules[] = 'scratchpads_blog';
    
    parent::setUp($modules);
    // Create users.
    $this->test_user = $this->drupalCreateUser(array(
      'access content'
    ));
    // We set the legal_accepted on the user so that login passes.
    parent::scratchpads_tweaks_legal_save($this->test_user->uid);
  }

  /**
   * Tests block_info() for the scratchpads blog module. 
   */
  public function testBlockInfo(){
    $info = module_invoke('scratchpads_blog', 'block_info');
    $this->assertEqual(1, count($info), t('Module defines a block'));
    $this->assertTrue(isset($info['blog_filters']), t('Blog Filters exists.'));
  }

  /**
   * Tests block_view() for the scratchpads blog module.
   */
  public function testBlockView(){
    $data = module_invoke('scratchpads_blog', 'block_view', 'blog_filters');
    $this->assertTrue(is_array($data), t('Block returns renderable array.'));
  }

  /**
   * Tests that the scratchpads_blog block appears on the correct pages.
   */
  public function testScratchpadsBlogBasic(){
    // Test that the block appears on the blog page
    $this->drupalLogin($this->test_user);
    $this->drupalGet('blog');
    $this->assertRaw('block-scratchpads-blog-blog-filters', 'Blog filter block present on blog page');
    $this->assertText(t('Filter by Author'), 'Blog filter block successfully displayed on blog page.');
    // Test that the block doesn't appears on the home page
    $this->drupalGet('');
    $this->assertnoRaw('block-scratchpads-blog-blog-filters', 'Blog filter block not present on home page');
    // test that the block appears on a blog entry page
    $blog_node = $this->drupalCreateNode(array(
      'type' => 'blog'
    ));
    $path = 'node/' . $blog_node->nid;
    $this->drupalGet($path);
    $this->assertRaw('block-scratchpads-blog-blog-filters', 'Blog filter block present on blog entry page');
    $this->assertText(t('Filter by Author'), 'Blog filter block successfully displayed on blog entry page.');
    // Test that the block doesn't appears on a node page with similar name
    $blog_node2= $this->drupalCreateNode(array(
      'title' => 'bloggs'
    ));
    $path2 = 'node/' . $blog_node2->nid;
    $this->drupalGet($path2);
    $this->assertnoRaw('block-scratchpads-blog-blog-filters', 'Blog filters not displayed on bloggs page');
  }
}