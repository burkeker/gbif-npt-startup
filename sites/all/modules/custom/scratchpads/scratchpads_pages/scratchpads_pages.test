<?php

/**
 * @file
*
* Scratchpads pages tests.
*/
class ScratchpadsPagesTestCase extends ScratchpadsTweaksTestCase{

  protected $admin_user;

  public static function getInfo(){
    return array(
      'name' => 'Scratchpads Pages',
      'description' => 'Tests scratchpads pages',
      'group' => 'Scratchpads'
    );
  }

  /**
   * Enable modules and create users with specific permissions.
   */
  public function setUp(){
    $modules[] = 'scratchpads_pages';
    $modules[] = 'scratchpads_blog';
    $modules[] = 'scratchpads_forum';
    parent::setUp($modules);
    //  Create users.
    $this->admin_user = $this->drupalCreateUser(array(
      'access content',
      'access administration pages',
      'administer site configuration',
      'administer users',
      'administer permissions',
      'administer content types',
      'administer nodes',
      'bypass node access',
      'access overlay',
      'access content overview',
      'view the administration theme',
      'access all views'
    ));
    // We set the legal_accepted on the user so that login passes.
    parent::scratchpads_tweaks_legal_save($this->admin_user->uid);
  }

  /**
   *  Test that locked content type's page display can't be modified
   */
  protected function testLockedTypes(){
    $this->drupalLogin($this->admin_user);
    $locked_types = scratchpads_pages_page_display_locked_types();
    foreach($locked_types as $locked_type){
      $this->drupalGet('admin/structure/types/manage/' . $locked_type);
      $edit = array();
      $edit['page_display_type'] = 'none';
      // custom method defined in scratchpads_tweaks
      $this->drupalAssertPostFail(NULL, $edit, 'Save content type');
    }
  }
 
 /**
  * Test that 'Page display' is present on all 'manage content type' pages,
  * then attempt to change the display if not locked. 
  */
  function testPageDisplay(){
    $this->drupalLogin($this->admin_user);
    $content_types = node_type_get_names();
    $locked_types = scratchpads_pages_page_display_locked_types();
    foreach($content_types as $machine_name=>$content_type){
      $this->drupalGet('admin/structure/types/manage/' . $machine_name);
      $this->assertText('Page display');
      $this->assertRaw('edit-page-display-type');
      // if not a locked type, attempt to change the page display   
      if (!in_array($machine_name, $locked_types)){
          $edit = array();
          $edit['page_display_type'] = 'none';
          $this->drupalPost(NULL, $edit, 'Save content type');
      }
      
    }
  }
  
}