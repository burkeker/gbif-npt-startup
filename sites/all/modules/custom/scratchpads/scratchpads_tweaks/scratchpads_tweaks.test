<?php
// Set the max execution time to 20 minutes.  This may seem like a long time,
// but the scratchpads_tweaks module does take a long time to install.
ini_set('max_execution_time', '1200');

/**
 * @file
 * 
 * Scratchpads Tweaks tests.  This enables us to test components on a "FULL"
 * Scratchpad.
 */
class ScratchpadsTweaksTestCase extends DrupalWebTestCase{

  protected $test_user;

  protected $profile = 'scratchpad_2';

  public static function getInfo(){
    return array(
      'name' => 'Scratchpads Tweaks',
      'description' => 'Enable all of the modules associated with a Scratchpad to see where errors occur.',
      'group' => 'Scratchpads',
      'dependencies' => array(
        'scratchpads_tweaks'
      )
    );
  }

  /**
   * Overrides DrupalWebTestCase setup()
   * Enable modules and create users with specific permissions.
   */
  function setUp(){
    $modules = func_get_args();
    if(isset($modules[0]) && is_array($modules[0])){
      $modules = $modules[0];
    }
    // include the code for tweaks setup
    include DRUPAL_ROOT . '/' . drupal_get_path('module', 'scratchpads_tweaks') . "/scratchpads_tweaks.inc";
    // Create users.
    $this->test_user = $this->drupalCreateUser(array(
      'access content'
    ));
    $this->scratchpads_tweaks_legal_save($this->test_user->uid);
  }

  /**
   * Overrides DrupalWebTestCase drupallogin().
   * @see DrupalWebTestCase::drupalLogin()
   */
  protected function drupalLogin(stdClass $account) {
    if ($this->loggedInUser) {
      $this->drupalLogout();
    }
  
    $edit = array(
      'name' => $account->name,
      'pass' => $account->pass_raw
    );
    $this->drupalPost('user', $edit, t('Log in'));
  
    // override is here
    $pass = $this->assertText('Member for', 'User successfully logged in');
  
    if ($pass) {
      $this->loggedInUser = $account;
    }
  }
  
  public function machine_name($human_name){
    $machine_readable = strtolower($human_name);
    $machine_readable = preg_replace('@[^a-z0-9_]+@','_',$machine_readable);
    return $machine_readable;
  }
  
  /**
   * We set the legal_accepted on the user so that login passes.
   */
  function scratchpads_tweaks_legal_save($uid){
    legal_save_accept(1, 1, 'en', $uid);
  }

  /**
   * Confirm that the front page is accessible when this module is installed.
   * This is a very simple test, but allows us to install all of the necessary
   * modules for testing other modules against a "full" Scratchpad.
   */
  function testAccessFrontPage(){
    $this->drupalLogin($this->test_user);
    $this->drupalGet('');
    $this->assertResponse(200);
  }
}

